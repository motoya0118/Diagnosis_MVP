# 4. 診断結果画面設計

## ページ概要
- Path: `/diagnostics/{diagnostic_code}/result`
- 遷移元: 共通診断画面（回答送信完了後）。
- 目的: 診断結果の上位3職種を視覚的に提示し、詳細情報を閲覧できるようにする。

## データ取得
1. URLクエリ `session_code` を取得（未指定の場合はトップへリダイレクト）。
2. 直前画面から `llm_result` が渡されていればそれを初期表示に利用しつつ、再読込時に `GET /sessions/{session_code}` をコールしてサニタイズ済み `llm_result` を取得する。
3. `llm_result` が `null` の場合は回答送信が完了していない（または `status=awaiting_llm` で生成待ち）状態として扱い、エラービューやポーリング表示で再診断/待機を案内する。
4. `GET /sessions/{session_code}` のレスポンスで返る `outcomes` から `outcome_meta_json.name` をキーに職種メタ情報（`mst_ai_jobs` のスナップショット）をハッシュ化する。セッションレスポンスにメタ情報が無い場合のみ、`version_id` をキーに `GET /diagnostics/versions/{version_id}/form` のキャッシュをフォールバック参照する。
- API 呼び出し中は `LoaderOverlay` を表示する。`llm_result` が未生成の状態では「結果を生成しています（Amazon Bedrock）...」、再読込中は「診断結果を読み込んでいます...」をメッセージとして表示し、完了するまで操作を無効化する。

### LLMレスポンス整形
- 受信フォーマットは `{ "1": {...}, "2": {...}, "3": {...} }` を想定。キー順で順位を決定し、配列 `topResults = [{rank: 1, ...}, ...]` に変換。
- 各要素は以下を保持する。
  - `name`: outcomeの表示名
  - `scores`: `total_match.score`, `personality_match.score`, `work_match.score`（0〜100）。
  - `reasons`: 各スコアの `reason` を優先順位付きで取得。キー欠損時は空文字。
  - `outcomeMeta`: `version_outcomes_meta[name]` が存在すれば付与。無い場合は `null`。
- UI 表示用に `chartData` を組み立てる。
  ```ts
  chartData = topResults.map(item => ({
    label: `${item.rank}. ${item.name}`,
    total: item.scores.total_match,
    personality: item.scores.personality_match,
    work: item.scores.work_match
  }));
  ```
- スコア値は 0〜100 の範囲で検証し、上限外はクリップする。

## UI構成
- ヘッダー: 診断名、再診断ボタン。
- ランキングサマリ
  - 上位3職種を順位カードとして横並び表示。カード内に `total_match.score` を円形ゲージ（ドーナツチャート）で表現し、スコア値と短いリード文（総合マッチ理由）を載せる。
- スコア比較グラフ
  - `chartData` を用いて 3 系列（総合・性格・仕事）の積み上げ横棒グラフを表示。凡例タブで各スコアの ON/OFF ができる。
  - 棒グラフをホバーすると対応する `reason` テキストのツールチップを表示する。
- 理由セクション
  - ランキング下部に Accordion を配し、各職種ごとに「総合」「性格」「業務」の根拠全文を表形式で掲載。理由テキストが空の場合は「理由は生成されませんでした」を表示。
- 詳細パネル
  - 職種名をクリックでモーダル（またはサイドパネル）を開き、`outcomeMeta` を用いた詳細情報を表示。
  - 詳細内コンテンツ例: 職種概要（role_summary）、主な役割（main_role）、関わり方（collaboration_style）、必要スキル（core_skills）、主な成果物（deliverables）、キャリアパス（pathway_detail）、推奨AIツール（ai_tools）、想定年収（avg_salary_jpy）など。`outcomeMeta` が存在しない場合は LLM 結果の理由テキストと簡易テンプレを表示する。
- 次アクションエリア
  - 会員登録、関連コース案内などへの導線ボタン。

### 職種詳細モーダル
- トリガー: 順位カード、グラフ凡例、理由セクション内の職種名をクリック。
- コンテンツ: `outcomeMeta` に含まれる `role_summary` / `main_role` / `collaboration_style` / `core_skills` / `deliverables` / `pathway_detail` / `ai_tools` / `avg_salary_jpy` 等と LLM理由を組み合わせ、セクション単位で提示する。
- 閉じる動作: モーダル右上×ボタン/ESC/背景クリック。スクロール位置は保持。

## 状態・例外
- API呼び出し中はローディングスケルトンを表示。
- `session_code` が無効の場合はエラーカードを表示し、再診断導線を提示。
- セッション詳細取得に失敗した場合や `llm_result` が未生成の場合は、診断完了前に遷移したと判断して共通診断画面への戻りリンクを案内する。
- `name` から `outcomeMeta` が解決できない場合は、警告トーストを表示しモーダルでは LLM理由のみを表示する。
- スコア値が欠損または非数値の場合は該当職種を非表示にし、フォールバックメッセージを提示する。

## ローディング挙動
- `LoaderOverlay` を共通コンポーネントとして利用し、診断結果の取得中や LLM 生成待ちの間は全画面を覆って操作をブロックする。スクロールロックと 200ms のフェードアニメーション、300ms の最小表示時間を維持する。
- メッセージは以下の通り切り替える。
  - 再読込・共有リンク復元時の初期取得: 「診断結果を読み込んでいます...」
  - `llm_result=null` でポーリング中: 「結果を生成しています（Amazon Bedrock）...」
- エラーまたは未生成警告表示時はローダーを解除し、既存のカード表示でリトライ導線を提示する。

## テスト観点
- LLM 出力の JSON パース成功/失敗時のハンドリング。
- グラフ表示: 3職種×3指標で横棒グラフが正しいスケール（0〜100）になること。
- 職種カードクリックでモーダルが開閉し、`outcomeMeta` の有無で表示が切り替わること。
- 部分欠損データ（スコア欠落/理由欠落）のフォールバック表示。
- 共有リンク生成（任意実装）の場合は `session_code` を外部に開示しない安全策の確認。
- ローダー表示中に操作がブロックされ、メッセージが取得フェーズ／生成フェーズに応じて切り替わること。
