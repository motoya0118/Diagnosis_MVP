# 5. 会員登録画面改修設計

## 対象ページ
- Path: `frontend/app/register/page.tsx`
- 目的: 診断回答が存在する場合に `session_code` を会員登録APIへ同時送信し、匿名診断結果をユーザーに紐づける。

## 現行仕様の整理
- フォーム項目: メールアドレス、パスワード、同意チェック。
- 現状は登録API (`12_ユーザー登録とセッション紐付け`) を `session_codes` なしで呼び出している。

## 改修方針
1. 画面初期化時にローカルストレージから診断履歴を読み出す。
2. `status === "completed"` のエントリから `session_code` を抽出し、重複を除外したリストを作成。
3. 登録フォーム送信時に `session_codes` を含むリクエストボディを組み立てる。

```ts
interface RegisterPayload {
  email: string;
  password: string;
  session_codes?: string[]; // 完了済み診断がある場合のみ付与
}
```

## ローカルストレージ仕様
- 共通診断画面と同じキーで保存される診断ステートを想定。
- 型:
  ```ts
  interface DiagnosticState {
    diagnostic_code: string;
    session_code: string;
    status: "in_progress" | "completed";
  }
  ```
- 取得ロジック
  - `for` ループでキーを走査し、`diagnostics:` プレフィックスなどでフィルタ。
  - JSON parse 失敗時は無視。

## バリデーション・UX
- `session_codes` が空配列の場合はフィールドごと除外（APIパラメータ最小化）。
- 登録成功後は診断ステートを必要に応じて削除/更新（サーバ連携完了済みフラグ）。
- APIエラー時はフォーム上部にメッセージを表示し、`session_codes` を保ったまま再試行可能とする。

## テスト観点
- 診断履歴なし（`session_codes` 未送信）での正常登録。
- 複数診断を完了した場合に重複なく送信されること。
- 登録失敗後の再送信で `session_codes` が保持されること。
