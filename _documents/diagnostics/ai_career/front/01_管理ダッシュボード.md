# 1. 管理ダッシュボード画面設計

## ページ概要
- Path: `/admin/dashboard`
- 目的: 診断版の作成〜配布までを1画面で操作できる運用ハブを提供する。
- 対象利用者: 管理者ユーザー（要ログイン）。
- レイアウト: ページ上部に診断選択系の共通フィルタ、下部に機能カード（6枚）を配置。

## 共通UI・状態管理
- 共通フィルタ
  - `診断名` セレクトボックス: `diagnostics` テーブルから取得した `id`/`name` を表示。(01_admin_get_diagnosticsを実行)
  - `バージョン` セレクトボックス: 診断選択後に `versions` を遅延ロード。finalize済み・未finalizeの双方を扱う（機能ごとにフィルタリング）。
- フィルタ値とロード済みデータは React state で保持し、APIレスポンスは `diagnosticId`/`versionId` をキーにキャッシュする。
- エラートースト/スナックバーを共通コンポーネントとして用意。API失敗・バリデーション失敗などを端的に表示する。
- ダウンロード・アップロード中は対象ボタンを `loading` 表示し、多重実行を防ぐ。

## 機能別仕様

### 1. 版の新規作成
- UI構成
  - `診断名` セレクト（必須）
  - `版名入力` text box（必須）:(VARCHAR(128)以内のバリデーションをつける)
  - `作成メモ` テキストエリア（任意）
  - `新規作成` ボタン
- 動作フロー
  1. `診断名` 未選択ならバリデーションエラー。
  2. `01_admin_get_diagnostics` を利用し診断一覧を初期ロード。
  3. ボタン押下で `02_admin_create_version` API を呼び出し、成功時にトースト表示/バージョンリストを再取得。
- エラー処理
  - バリデーションエラーはフォーム下に表示。
  - APIエラーはコードに応じたメッセージ（409=既存ドラフトあり等）。

### 2. テンプレートダウンロード
- UI構成
- `診断名` セレクト（必須）
- `バージョン` セレクト（必須、0=初期テンプレート／Draft・Finalized を含む）
  - `テンプレートDL` ボタン
- 動作フロー
  1. 診断選択時に `05_admin_list_versions` を呼び出し `version_id/name` を取得。
  2. バージョン未選択時はバリデーションエラー。
  3. ボタン押下で `03_admin_get_template` API を呼び出し、レスポンスのバイナリを `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet` としてDL。
- エラー処理: APIエラーはモーダル表示（DLエラーの可視化）。

### 3. SYSTEM_PROMPT登録更新
- UI構成
  - `診断名` セレクト（必須）
  - `バージョン` セレクト（必須、Draftのみ選択可。Finalize済みは `disabled` 表示）
  - `SYSTEM_PROMPT` テキストエリア（全画面横幅、行数自動拡張、10万文字カウンタ付き）
  - `更新メモ` テキストエリア（任意、監査ログ用）
  - `最終更新: yyyy/MM/dd HH:mm（更新者名）` のラベル表示
  - `保存` ボタンと `リセット` ボタン（API取得値へ戻す）
- 動作フロー
  1. 診断選択時に `05_admin_list_versions` を利用し Draft 版のみを候補に表示。Finalize 版は選択不可としてラベルに `(finalize済)` を付与。
  2. バージョン選択で `10_admin_get_version_detail` を呼び、`system_prompt_preview` と最終更新者情報を取得。全文は `GET /admin/diagnostics/versions/{version_id}/system-prompt` を呼び出してテキストエリアへ差し込む。
  3. 編集はリアルタイムにローカル state に保持し、文字数が10万を超えたら保存ボタンを `disabled`。
  4. 保存押下で `06_admin_update_system_prompt` を呼び出し、`system_prompt` と `note`（=更新メモ）を送信。成功時はトースト表示し、最新の `updated_at`/`updated_by_admin_id` を再取得してラベルへ反映。
  5. `リセット` ボタンで再取得した元のプロンプトへ戻す。
- エラー処理
  - 409 (`E020_VERSION_FROZEN`): finalize 済みの版を選んだ場合は即座にモーダルで通知し、選択を解除。
  - 400 (`E031_IMPORT_VALIDATION`): 文字数オーバー時はテキストエリア下にエラーを表示し保存不可。
  - 404 (`E010_VERSION_NOT_FOUND`): バージョン削除済みの場合はトースト表示後、バージョンセレクトを空に戻す。
  - その他の API エラーは共通トーストで通知し、ローカル編集内容は保持する。

### 4. 版フリーズ
- UI構成
  - `診断名` セレクト（必須）
  - `末フリーズ版` セレクト（必須、ドラフトおよびfinalize前の版）
  - `版フリーズ` ボタン
- 動作フロー
  1. ボタン押下時に確認モーダルを表示（`本当にフリーズしますか？`）
  2. 承認後に `07_admin_finalize_version` API 呼び出し。
  3. 成功したらバージョン一覧を再取得し、finalize済みリストに反映。
- エラー処理: 409/422はモーダル内で詳細表示（既にfinalize済みなど）。

### 5. アクティブバージョン選択
- UI構成
  - 診断ごとのアクティブ版を一覧表示するカード（`診断名 / 現在のアクティブ版 / 更新ボタン`）
  - `診断名` フィルタとは独立に全診断分を表示。
- 動作フロー
  1. 初期表示で `09_admin_get_active_version` を実行し各診断の取得。
  2. 更新ボタン押下でモーダルを開き、候補版のラジオリストを提示。
  3. `08_admin_activate_version` API 成功時に一覧を更新し、トーストを表示。
- エラー処理: API失敗はモーダル内にエラーメッセージを表示し閉じない。

## 状態遷移と権限
- すべての操作は管理者JWT必須。未認証時はログイン画面へリダイレクト。
- 版操作に伴う再取得は `Promise.all` で最新状態を取得し、UIの整合性を担保。

## テスト観点
- バリデーション: 必須項目、拡張子、サイズチェック。
- API失敗時のメッセージ表示。
- 連続操作（同一ファイル二度フェッチなど）のガード。
- finalize実行後にアクティブ選択候補へ即時反映されること。
